name: Release Policy

on:
  workflow_dispatch:
    inputs:
      policy:
        description: "Policy folder name (e.g., ratelimit)"
        required: true
        type: string
      version:
        description: "Version (SemVer: X.Y.Z | X.Y.Z-dev.N | X.Y.Z-rc.N)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release-policy:
    name: Validate, Test & Release Policy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Validate inputs
      # ------------------------------------------------------------
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          POLICY="${{ github.event.inputs.policy }}"
          VERSION="${{ github.event.inputs.version }}"

          if ! [[ "$POLICY" =~ ^[a-zA-Z0-9-]+$ ]]; then
            echo "âŒ Invalid policy name: $POLICY"
            exit 1
          fi

          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(dev|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            exit 1
          fi

          echo "âœ… Inputs validated"

      # ------------------------------------------------------------
      # Resolve module metadata
      # ------------------------------------------------------------
      - name: Resolve module metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          POLICY="${{ github.event.inputs.policy }}"
          VERSION="${{ github.event.inputs.version }}"
          MAJOR="${VERSION%%.*}"

          if [[ "$MAJOR" == "0" || "$MAJOR" == "1" ]]; then
            TARGET_DIR="policies/$POLICY"
            MODULE_PATH="github.com/${{ github.repository }}/policies/$POLICY"
          else
            TARGET_DIR="policies/$POLICY/v$MAJOR"
            MODULE_PATH="github.com/${{ github.repository }}/policies/$POLICY/v$MAJOR"
          fi

          TAG_NAME="policies/$POLICY/v$VERSION"

          echo "target_dir=$TARGET_DIR" >> "$GITHUB_OUTPUT"
          echo "module_path=$MODULE_PATH" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # Validate policy structure
      # ------------------------------------------------------------
      - name: Validate policy structure
        shell: bash
        run: |
          set -euo pipefail

          DIR="${{ steps.meta.outputs.target_dir }}"

          [[ -d "$DIR" ]] || { echo "âŒ Missing directory: $DIR"; exit 1; }

          for f in go.mod policy-definition.yaml; do
            [[ -f "$DIR/$f" ]] || { echo "âŒ Missing $f in $DIR"; exit 1; }
          done

          EXPECTED="${{ steps.meta.outputs.module_path }}"
          ACTUAL=$(grep '^module ' "$DIR/go.mod" | awk '{print $2}')

          [[ "$EXPECTED" == "$ACTUAL" ]] || {
            echo "âŒ go.mod module mismatch"
            echo "Expected: $EXPECTED"
            echo "Actual:   $ACTUAL"
            exit 1
          }

          echo "âœ… Policy structure valid"

      # ------------------------------------------------------------
      # Validate version consistency
      # ------------------------------------------------------------
      - name: Validate version consistency
        shell: bash
        run: |
          set -euo pipefail

          DIR="${{ steps.meta.outputs.target_dir }}"
          INPUT_VERSION="${{ github.event.inputs.version }}"

          # Extract version from policy-definition.yaml
          POLICY_DEF_VERSION=$(yq eval '.version' "$DIR/policy-definition.yaml")

          # Remove 'v' prefix if present in policy-definition.yaml
          POLICY_DEF_VERSION=${POLICY_DEF_VERSION#v}

          echo "Input version: $INPUT_VERSION"
          echo "Policy definition version: $POLICY_DEF_VERSION"

          if [[ "$INPUT_VERSION" != "$POLICY_DEF_VERSION" ]]; then
            echo "âŒ Version mismatch!"
            echo "The version specified in the workflow input ($INPUT_VERSION) does not match"
            echo "the version in the policy-definition.yaml file ($POLICY_DEF_VERSION)."
            echo "Please update the policy-definition.yaml version to v$INPUT_VERSION or"
            echo "use version $POLICY_DEF_VERSION in the workflow input."
            exit 1
          fi

          echo "âœ… Version consistency validated"

      # ------------------------------------------------------------
      # Setup Go
      # ------------------------------------------------------------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ steps.meta.outputs.target_dir }}/go.mod
          cache: false

      # ------------------------------------------------------------
      # Run tests
      # ------------------------------------------------------------
      - name: Run policy tests
        working-directory: ${{ steps.meta.outputs.target_dir }}
        shell: bash
        run: |
          set -euo pipefail
          go test -v -race ./...

      # ------------------------------------------------------------
      # Git hygiene
      # ------------------------------------------------------------
      - name: Ensure clean working tree
        shell: bash
        run: |
          set -euo pipefail
          git diff --exit-code
          test -z "$(git status --porcelain)"

      # ------------------------------------------------------------
      # Ensure version uniqueness
      # ------------------------------------------------------------
      - name: Ensure version is new
        shell: bash
        run: |
          set -euo pipefail
          if git rev-parse "${{ steps.meta.outputs.tag_name }}" >/dev/null 2>&1; then
            echo "âŒ Tag already exists: ${{ steps.meta.outputs.tag_name }}"
            echo "Existing tag information:"
            git show "${{ steps.meta.outputs.tag_name }}" --no-patch --format="%H %s (%ai)"
            exit 1
          else
            echo "âœ… Version is new"
          fi

      # ------------------------------------------------------------
      # Register Policy in Policy Hub (MANDATORY, multipart)
      # ------------------------------------------------------------
      - name: Register policy in Policy Hub
        if: false  # Temporarily disabled
        id: policy-hub
        shell: bash
        env:
          POLICY_HUB_URL: ${{ secrets.POLICY_HUB_URL }}
          POLICY_HUB_TOKEN: ${{ secrets.POLICY_HUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ -z "${POLICY_HUB_URL:-}" || -z "${POLICY_HUB_TOKEN:-}" ]]; then
            echo "registration_status=skipped" >> "$GITHUB_OUTPUT"
            echo "registration_message=Missing POLICY_HUB_URL or POLICY_HUB_TOKEN" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          DIR="${{ steps.meta.outputs.target_dir }}"

          RESPONSE=$(curl -sSL -w "HTTPSTATUS:%{http_code}" \
            -X POST "$POLICY_HUB_URL/policies/register" \
            -H "Authorization: Bearer $POLICY_HUB_TOKEN" \
            -F "policy=${{ github.event.inputs.policy }}" \
            -F "version=${{ github.event.inputs.version }}" \
            -F "module_path=${{ steps.meta.outputs.module_path }}" \
            -F "repository=${{ github.repository }}" \
            -F "policy_definition=@$DIR/policy-definition.yaml;type=application/yaml")

          STATUS=$(echo "$RESPONSE" | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\1/')
          BODY=$(echo "$RESPONSE" | sed -E 's/HTTPSTATUS:[0-9]{3}$//')

          if [[ "$STATUS" =~ ^(200|201)$ ]]; then
            echo "registration_status=success" >> "$GITHUB_OUTPUT"
            echo "registration_message=Policy registered successfully" >> "$GITHUB_OUTPUT"
          else
            echo "registration_status=failed" >> "$GITHUB_OUTPUT"
            echo "registration_message=HTTP $STATUS: $BODY" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # Set default Policy Hub outputs (since registration is disabled)
      # ------------------------------------------------------------
      - name: Set default Policy Hub outputs
        id: policy-hub-default
        shell: bash
        run: |
          echo "registration_status=skipped" >> "$GITHUB_OUTPUT"
          echo "registration_message=Policy Hub registration disabled for testing" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # Resolve final Policy Hub status
      # ------------------------------------------------------------
      - name: Resolve Policy Hub status
        id: policy-hub-final
        shell: bash
        run: |
          # Use actual Policy Hub result if it ran, otherwise use default
          if [[ "${{ steps.policy-hub.conclusion }}" == "success" || "${{ steps.policy-hub.conclusion }}" == "failure" ]]; then
            echo "registration_status=${{ steps.policy-hub.outputs.registration_status }}" >> "$GITHUB_OUTPUT"
            echo "registration_message=${{ steps.policy-hub.outputs.registration_message }}" >> "$GITHUB_OUTPUT"
          else
            echo "registration_status=${{ steps.policy-hub-default.outputs.registration_status }}" >> "$GITHUB_OUTPUT"
            echo "registration_message=${{ steps.policy-hub-default.outputs.registration_message }}" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # Create and push Git tag (only on successful registration or skipped)
      # ------------------------------------------------------------
      - name: Create and push tag
        if: steps.policy-hub-final.outputs.registration_status == 'success' || steps.policy-hub-final.outputs.registration_status == 'skipped'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag -a "${{ steps.meta.outputs.tag_name }}" \
            -m "Release ${{ github.event.inputs.policy }} v${{ github.event.inputs.version }}"

          git push "https://x-access-token:$GITHUB_TOKEN@github.com/${{ github.repository }}.git" \
            "${{ steps.meta.outputs.tag_name }}"

      # ------------------------------------------------------------
      # Verify Go module resolution (only on successful registration or skipped)
      # ------------------------------------------------------------
      # - name: Verify Go module resolution
      #   if: steps.policy-hub-default.outputs.registration_status == 'success' || steps.policy-hub-default.outputs.registration_status == 'skipped'
      #   shell: bash
      #   run: |
      #     set -euo pipefail

      #     MOD="${{ steps.meta.outputs.module_path }}"
      #     VER="v${{ github.event.inputs.version }}"

      #     for i in 1 2 3; do
      #       if go list -m "$MOD@$VER"; then
      #         echo "âœ… Module resolved"
      #         exit 0
      #       fi
      #       sleep 15
      #     done

      #     echo "âŒ Go module resolution failed"
      #     exit 1

      # ------------------------------------------------------------
      # Publish summary (Markdown)
      # ------------------------------------------------------------
      - name: Publish summary
        run: |
          case "${{ steps.policy-hub-final.outputs.registration_status }}" in
            success)
              TITLE=" Policy Released Successfully"
              HUB="âœ… Policy Hub registration successful"
              ACTION=""
              TAG_STATUS="âœ… Git tag created"
              MODULE_STATUS="âœ… Go module verified"
              ;;
            skipped)
              TITLE="ðŸŽ‰ Policy Released Successfully"
              HUB="â„¹ï¸ Policy Hub registration skipped (not configured)"
              ACTION=""
              TAG_STATUS="âœ… Git tag created"
              MODULE_STATUS="âœ… Go module verified"
              ;;
            failed)
              TITLE="âŒ Policy Release Failed"
              HUB="âŒ Policy Hub registration failed"
              ACTION="**Fix:** Review Policy Hub error details above and retry."
              TAG_STATUS="âŒ Git tag not created"
              MODULE_STATUS="âŒ Go module not verified"
              ;;
            *)
              TITLE="âŒ Policy Release Failed"
              HUB="âŒ Unknown Policy Hub state"
              ACTION="**Fix:** Inspect workflow logs."
              TAG_STATUS="âŒ Git tag not created"
              MODULE_STATUS="âŒ Go module not verified"
              ;;
          esac

          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # $TITLE

          | Item | Value |
          |------|------|
          | Policy | \`${{ github.event.inputs.policy }}\` |
          | Version | \`${{ github.event.inputs.version }}\` |
          | Tag | \`${{ steps.meta.outputs.tag_name }}\` |
          | Go Module | \`${{ steps.meta.outputs.module_path }}\` |

          ## Status
          âœ… Tests passed  
          $TAG_STATUS  
          $MODULE_STATUS  
          $HUB

          $ACTION
          EOF

      # ------------------------------------------------------------
      # Final status enforcement
      # ------------------------------------------------------------
      - name: Final status check
        shell: bash
        run: |
          case "${{ steps.policy-hub-final.outputs.registration_status }}" in
            success|skipped)
              echo "âœ… Workflow completed successfully"
              exit 0
              ;;
            *)
              echo "âŒ Workflow failed due to Policy Hub registration"
              exit 1
              ;;
          esac
