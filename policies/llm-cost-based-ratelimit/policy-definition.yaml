name: llm-cost-based-ratelimit
version: v0.1.0
description: |
  A specialized rate limiting policy for LLMs that limits usage based on monetary budgets.
  Gateway administrators configure the cost per token (e.g., $0.002 per 1000 tokens) as
  system parameters, while API consumers define their spending budgets (e.g., $10 per hour,
  $100 per day) as user parameters. The policy dynamically resolves token extraction paths
  from LLM Provider Templates and delegates the actual rate limiting to the
  advanced-ratelimit engine with cost extraction.

parameters:
  type: object
  additionalProperties: false
  properties:
    budgetLimits:
      type: array
      description: |
        Budget limits define the maximum amount of money the user is willing to spend
        within specific time windows. Multiple limits can be configured for different
        time granularities (e.g., per hour, per day, per month).
      minItems: 1
      maxItems: 10
      items:
        type: object
        additionalProperties: false
        required: ["amount", "duration"]
        properties:
          amount:
            type: number
            description: |
              Maximum monetary budget allowed in the specified time window.
              This is the spending cap that the user defines (e.g., 10 for $10).
            minimum: 0.000001
            maximum: 1000000
          duration:
            type: string
            description: |
              Time window for the budget limit (Go duration string format).
              Examples: "1h" (1 hour), "24h" (1 day), "168h" (1 week), "720h" (30 days)
            pattern: "^[-+]?(([0-9]+(\\.[0-9]*)?|\\.[0-9]+)(ns|us|Âµs|ms|s|m|h))+$"

systemParameters:
  type: object
  additionalProperties: false
  properties:
    # Token cost configuration - set by gateway admin
    promptTokenCost:
      type: number
      description: |
        Cost per prompt (input) token unit. This is set by the gateway administrator
        and represents the price charged by the LLM provider for input tokens.
        Example: 0.002 means $0.002 per 1,000,000 tokens (default unit).
        Use costPerNTokens to configure a different token unit size.
      minimum: 0
      default: 0
      "wso2/defaultValue": "${config.policy_configurations.llm_cost_ratelimit.prompt_token_cost}"

    completionTokenCost:
      type: number
      description: |
        Cost per completion (output) token unit. This is set by the gateway administrator
        and represents the price charged by the LLM provider for output tokens.
        Example: 0.006 means $0.006 per 1,000,000 tokens (default unit).
        Use costPerNTokens to configure a different token unit size.
      minimum: 0
      default: 0
      "wso2/defaultValue": "${config.policy_configurations.llm_cost_ratelimit.completion_token_cost}"

    totalTokenCost:
      type: number
      description: |
        Cost per total token (input + output) unit. Used when individual prompt/completion
        costs are not specified or as a fallback. This provides a simplified pricing model.
        Example: 0.002 means $0.002 per 1,000,000 tokens (default unit).
        Use costPerNTokens to configure a different token unit size.
      minimum: 0
      default: 0
      "wso2/defaultValue": "${config.policy_configurations.llm_cost_ratelimit.total_token_cost}"

    costPerNTokens:
      type: integer
      description: |
        The number of tokens that the cost applies to. This allows gateway administrators
        to configure costs in more convenient units (e.g., per 1000 tokens instead of per single token).
        Example: If costPerNTokens=1000 and promptTokenCost=0.002, then each prompt token costs $0.000002.
        This value applies to all token types (prompt, completion, and total).
      minimum: 1
      default: 1000000
      "wso2/defaultValue": "${config.policy_configurations.llm_cost_ratelimit.cost_per_n_tokens}"

    costScaleFactor:
      type: integer
      description: |
        Scale factor for converting dollar amounts to internal units for precision.
        The underlying rate limiter uses int64 counters, so costs less than 1 would be
        truncated to 0 without scaling. This factor scales both the budget limits and
        the cost multipliers to preserve precision.

        Example values:
        - 1000000000 (default): Nano-dollars. $1.00 = 1,000,000,000 units. Precision to 9 decimal places.
          Recommended for high-volume LLM APIs where per-token costs are very small.
        - 1000000: Micro-dollars. $1.00 = 1,000,000 units. Precision to 6 decimal places.
        - 1000: Milli-dollars. $1.00 = 1,000 units. Precision to 3 decimal places.
        - 100: Cents. $1.00 = 100 units. Precision to 2 decimal places.

        The response headers will include both the raw scaled values and human-readable
        dollar amounts (x-ratelimit-cost-limit-dollars, x-ratelimit-cost-remaining-dollars).
      minimum: 1
      default: 1000000000
      "wso2/defaultValue": "${config.policy_configurations.llm_cost_ratelimit.cost_scale_factor}"

    # Rate limiting algorithm and backend - inherited from advanced-ratelimit
    algorithm:
      type: string
      description: |
        Rate limiting algorithm to use:
        - gcra: Generic Cell Rate Algorithm (default). Provides smooth rate limiting
          with burst support and token bucket semantics.
        - fixed-window: Simple fixed time window counter. Lower computational overhead
          but can allow up to 2x burst at window boundaries.
      enum: ["gcra", "fixed-window"]
      default: "gcra"
      "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.algorithm}"

    backend:
      type: string
      description: |
        Rate limit storage backend. 'memory' for in-memory storage (single-instance),
        'redis' for distributed rate limiting across multiple gateway instances.
      enum: ["memory", "redis"]
      default: "memory"
      "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.backend}"

    redis:
      type: object
      description: Redis configuration (only used when backend=redis)
      additionalProperties: false
      properties:
        host:
          type: string
          default: "localhost"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.host}"
        port:
          type: integer
          default: 6379
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.port}"
        password:
          type: string
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.password}"
        username:
          type: string
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.username}"
        db:
          type: integer
          default: 0
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.db}"
        keyPrefix:
          type: string
          default: "ratelimit:v1:"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.keyprefix}"
        failureMode:
          type: string
          enum: ["open", "closed"]
          default: "open"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.failuremode}"
        connectionTimeout:
          type: string
          default: "5s"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.connectiontimeout}"
        readTimeout:
          type: string
          default: "3s"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.readtimeout}"
        writeTimeout:
          type: string
          default: "3s"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.writetimeout}"

    memory:
      type: object
      description: In-memory storage configuration (only used when backend=memory)
      additionalProperties: false
      properties:
        maxEntries:
          type: integer
          default: 10000
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.memory.maxentries}"
        cleanupInterval:
          type: string
          default: "5m"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.memory.cleanupinterval}"